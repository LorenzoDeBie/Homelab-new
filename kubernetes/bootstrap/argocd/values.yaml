# ArgoCD Helm values
# Chart: argo/argo-cd

global:
  domain: argocd.int.lorenzodebie.be

configs:
  params:
    # Run in insecure mode - TLS terminated at ingress/gateway
    server.insecure: true
  cm:
    # Enable status badge
    statusbadge.enabled: true
    # Enable exec into pods
    exec.enabled: true
    # Kustomize with Helm support
    kustomize.buildOptions: --enable-helm
    # Resource tracking
    resource.customizations.health.argoproj.io_Application: |
      hs = {}
      hs.status = "Progressing"
      hs.message = ""
      if obj.status ~= nil then
        if obj.status.health ~= nil then
          hs.status = obj.status.health.status
          if obj.status.health.message ~= nil then
            hs.message = obj.status.health.message
          end
        end
      end
      return hs
  # SOPS age decryption
  cmp:
    create: true
    plugins:
      sops:
        allowConcurrency: true
        discover:
          fileName: "*.sops.yaml"
        generate:
          command:
            - sh
            - "-c"
            - |
              sops --decrypt $ARGOCD_ENV_FILE
        lockRepo: false

repoServer:
  # Mount SOPS age key
  volumes:
    - name: sops-age
      secret:
        secretName: sops-age
    - name: custom-tools
      emptyDir: {}
  volumeMounts:
    - name: sops-age
      mountPath: /home/argocd/.config/sops/age
    - name: custom-tools
      mountPath: /usr/local/bin/sops
      subPath: sops
  
  # Install SOPS binary
  initContainers:
    - name: install-sops
      image: alpine:latest
      command:
        - sh
        - -c
        - |
          wget -qO /custom-tools/sops https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.amd64
          chmod +x /custom-tools/sops
      volumeMounts:
        - name: custom-tools
          mountPath: /custom-tools
  
  env:
    - name: SOPS_AGE_KEY_FILE
      value: /home/argocd/.config/sops/age/keys.txt

server:
  # Metrics for Prometheus
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

controller:
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

redis:
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

applicationSet:
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

notifications:
  enabled: true
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
