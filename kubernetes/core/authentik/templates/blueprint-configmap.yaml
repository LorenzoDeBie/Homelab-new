# ConfigMap containing blueprint for arr apps proxy providers
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-arr-apps-blueprint
  namespace: authentik
data:
  arr-apps-proxy.yaml: |
    # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
    version: 1
    metadata:
      name: Arr Apps Proxy Providers
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      # Create media-users group for access control
      - model: authentik_core.group
        id: media-users-group
        identifiers:
          name: media-users
        attrs:
          is_superuser: false

      # Create torrent-admins group for qBittorrent access control
      - model: authentik_core.group
        id: torrent-admins-group
        identifiers:
          name: torrent-admins
        attrs:
          is_superuser: false

      # Expression policy to check media-users group membership
      - model: authentik_policies_expression.expressionpolicy
        id: media-access-policy
        identifiers:
          name: media-apps-access
        attrs:
          expression: |
            return ak_is_group_member(request.user, name="media-users")

      # Expression policy to check torrent-admins group membership
      - model: authentik_policies_expression.expressionpolicy
        id: torrent-access-policy
        identifiers:
          name: torrent-apps-access
        attrs:
          expression: |
            return ak_is_group_member(request.user, name="torrent-admins")

      # Sonarr Proxy Provider
      - model: authentik_providers_proxy.proxyprovider
        id: sonarr-proxy-provider
        identifiers:
          name: sonarr-proxy
        attrs:
          external_host: https://sonarr.int.lorenzodebie.be
          internal_host: http://sonarr.media.svc.cluster.local:8989
          mode: proxy
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      # Radarr Proxy Provider
      - model: authentik_providers_proxy.proxyprovider
        id: radarr-proxy-provider
        identifiers:
          name: radarr-proxy
        attrs:
          external_host: https://radarr.int.lorenzodebie.be
          internal_host: http://radarr.media.svc.cluster.local:7878
          mode: proxy
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      # Prowlarr Proxy Provider
      - model: authentik_providers_proxy.proxyprovider
        id: prowlarr-proxy-provider
        identifiers:
          name: prowlarr-proxy
        attrs:
          external_host: https://prowlarr.int.lorenzodebie.be
          internal_host: http://prowlarr.media.svc.cluster.local:9696
          mode: proxy
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      # qBittorrent Proxy Provider
      - model: authentik_providers_proxy.proxyprovider
        id: qbittorrent-proxy-provider
        identifiers:
          name: qbittorrent-proxy
        attrs:
          external_host: https://qbittorrent.int.lorenzodebie.be
          internal_host: http://qbittorrent-app.media.svc.cluster.local:8080
          mode: proxy
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]

      # Sonarr Application
      - model: authentik_core.application
        id: sonarr-app
        identifiers:
          slug: sonarr
        attrs:
          name: Sonarr
          provider: !KeyOf sonarr-proxy-provider
          meta_launch_url: https://sonarr.int.lorenzodebie.be
          policy_engine_mode: any

      # Radarr Application
      - model: authentik_core.application
        id: radarr-app
        identifiers:
          slug: radarr
        attrs:
          name: Radarr
          provider: !KeyOf radarr-proxy-provider
          meta_launch_url: https://radarr.int.lorenzodebie.be
          policy_engine_mode: any

      # Prowlarr Application
      - model: authentik_core.application
        id: prowlarr-app
        identifiers:
          slug: prowlarr
        attrs:
          name: Prowlarr
          provider: !KeyOf prowlarr-proxy-provider
          meta_launch_url: https://prowlarr.int.lorenzodebie.be
          policy_engine_mode: any

      # qBittorrent Application
      - model: authentik_core.application
        id: qbittorrent-app
        identifiers:
          slug: qbittorrent
        attrs:
          name: qBittorrent
          provider: !KeyOf qbittorrent-proxy-provider
          meta_launch_url: https://qbittorrent.int.lorenzodebie.be
          policy_engine_mode: any

      # Policy bindings - bind media-access-policy to each application
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf sonarr-app
          order: 0
        attrs:
          policy: !KeyOf media-access-policy
          negate: false
          enabled: true
          timeout: 30

      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf radarr-app
          order: 0
        attrs:
          policy: !KeyOf media-access-policy
          negate: false
          enabled: true
          timeout: 30

      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf prowlarr-app
          order: 0
        attrs:
          policy: !KeyOf media-access-policy
          negate: false
          enabled: true
          timeout: 30

      # Policy binding - bind torrent-access-policy to qBittorrent
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf qbittorrent-app
          order: 0
        attrs:
          policy: !KeyOf torrent-access-policy
          negate: false
          enabled: true
          timeout: 30

      # Update embedded outpost to include these applications
      - model: authentik_outposts.outpost
        identifiers:
          name: authentik Embedded Outpost
        attrs:
          type: proxy
          providers:
            - !KeyOf sonarr-proxy-provider
            - !KeyOf radarr-proxy-provider
            - !KeyOf prowlarr-proxy-provider
            - !KeyOf qbittorrent-proxy-provider
          config:
            authentik_host: https://auth.int.lorenzodebie.be

---
# ConfigMap containing blueprint for ArgoCD OIDC provider
apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-argocd-blueprint
  namespace: authentik
data:
  argocd-oidc.yaml: |
    # yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
    version: 1
    metadata:
      name: ArgoCD OIDC Provider
      labels:
        blueprints.goauthentik.io/instantiate: "true"
    entries:
      # Create argocd-admins group
      - model: authentik_core.group
        id: argocd-admins-group
        identifiers:
          name: argocd-admins
        attrs:
          is_superuser: false

      # Expression policy to check argocd-admins group membership
      - model: authentik_policies_expression.expressionpolicy
        id: argocd-access-policy
        identifiers:
          name: argocd-admins-access
        attrs:
          expression: |
            return ak_is_group_member(request.user, name="argocd-admins")

      # OAuth2/OIDC Provider for ArgoCD
      - model: authentik_providers_oauth2.oauth2provider
        id: argocd-oidc-provider
        identifiers:
          name: argocd-oidc
        attrs:
          client_type: confidential
          client_id: argocd
          # Client secret - read from environment variable (set via Kubernetes secret)
          # Must match the secret in ArgoCD's oidc config
          client_secret: !Env ARGOCD_OIDC_CLIENT_SECRET
          authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-implicit-consent]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, default-provider-invalidation-flow]]
          redirect_uris: |
            https://argocd.int.lorenzodebie.be/auth/callback
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, authentik Self-signed Certificate]]
          # Include groups in the token
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
          sub_mode: hashed_user_id
          include_claims_in_id_token: true
          access_token_validity: minutes=5
          refresh_token_validity: days=30

      # Scope mapping for groups - returns user's group names
      - model: authentik_providers_oauth2.scopemapping
        id: argocd-groups-scope
        identifiers:
          name: ArgoCD Groups Scope
        attrs:
          scope_name: groups
          expression: |
            return [group.name for group in user.ak_groups.all()]

      # Bind the groups scope to the provider
      - model: authentik_providers_oauth2.oauth2provider
        id: argocd-oidc-provider-with-groups
        identifiers:
          name: argocd-oidc
        attrs:
          property_mappings:
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-openid]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-email]]
            - !Find [authentik_providers_oauth2.scopemapping, [managed, goauthentik.io/providers/oauth2/scope-profile]]
            - !KeyOf argocd-groups-scope

      # ArgoCD Application
      - model: authentik_core.application
        id: argocd-app
        identifiers:
          slug: argocd
        attrs:
          name: ArgoCD
          provider: !KeyOf argocd-oidc-provider
          meta_launch_url: https://argocd.int.lorenzodebie.be
          policy_engine_mode: any

      # Policy binding - only argocd-admins can access
      - model: authentik_policies.policybinding
        identifiers:
          target: !KeyOf argocd-app
          order: 0
        attrs:
          policy: !KeyOf argocd-access-policy
          negate: false
          enabled: true
          timeout: 30
