# Values passed to the authentik subchart
authentik:
  # Global settings
  authentik:
    secret_key: ""  # Set via secret
    error_reporting:
      enabled: false
    postgresql:
      password: ""  # Set via secret
  
  # Use external secret for credentials
  global:
    env:
      - name: AUTHENTIK_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: secret-key
      - name: AUTHENTIK_POSTGRESQL__PASSWORD
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: postgresql-password
      - name: AUTHENTIK_BOOTSTRAP_PASSWORD
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: bootstrap-password
      - name: AUTHENTIK_BOOTSTRAP_EMAIL
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: bootstrap-email
      - name: AUTHENTIK_REDIS__PASSWORD
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: redis-password
      # ArgoCD OIDC client secret - used by blueprint via !Env tag
      - name: ARGOCD_OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: argocd-oidc-client-secret
      # Grafana OIDC client secret - used by blueprint via !Env tag
      - name: GRAFANA_OIDC_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: authentik-secrets
            key: grafana-oidc-client-secret
  
  server:
    replicas: 1
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
    # Mount custom blueprints
    volumes:
      - name: arr-apps-blueprint
        configMap:
          name: authentik-arr-apps-blueprint
      - name: argocd-blueprint
        configMap:
          name: authentik-argocd-blueprint
      - name: grafana-blueprint
        configMap:
          name: authentik-grafana-blueprint
    volumeMounts:
      - name: arr-apps-blueprint
        mountPath: /blueprints/custom/arr-apps-proxy.yaml
        subPath: arr-apps-proxy.yaml
      - name: argocd-blueprint
        mountPath: /blueprints/custom/argocd-oidc.yaml
        subPath: argocd-oidc.yaml
      - name: grafana-blueprint
        mountPath: /blueprints/custom/grafana-oidc.yaml
        subPath: grafana-oidc.yaml
  
  worker:
    replicas: 1
    # Mount custom blueprints
    volumes:
      - name: arr-apps-blueprint
        configMap:
          name: authentik-arr-apps-blueprint
      - name: argocd-blueprint
        configMap:
          name: authentik-argocd-blueprint
      - name: grafana-blueprint
        configMap:
          name: authentik-grafana-blueprint
    volumeMounts:
      - name: arr-apps-blueprint
        mountPath: /blueprints/custom/arr-apps-proxy.yaml
        subPath: arr-apps-proxy.yaml
      - name: argocd-blueprint
        mountPath: /blueprints/custom/argocd-oidc.yaml
        subPath: argocd-oidc.yaml
      - name: grafana-blueprint
        mountPath: /blueprints/custom/grafana-oidc.yaml
        subPath: grafana-oidc.yaml
  
  # Embedded PostgreSQL
  postgresql:
    enabled: true
    auth:
      existingSecret: authentik-secrets
      secretKeys:
        adminPasswordKey: postgresql-password
        userPasswordKey: postgresql-password
    # Run as UID/GID 3001 (media user) to match NFS Mapall setting
    # This avoids needing root_squash disabled on NFS
    primary:
      containerSecurityContext:
        runAsUser: 3001
        runAsGroup: 3001
      podSecurityContext:
        fsGroup: 3001
      persistence:
        enabled: true
        storageClass: nfs-config
        size: 8Gi
  
  # Embedded Redis
  redis:
    enabled: true
    architecture: standalone
    auth:
      enabled: true
      existingSecret: authentik-secrets
      existingSecretPasswordKey: redis-password
    master:
      persistence:
        enabled: true
        storageClass: nfs-config
        size: 2Gi
