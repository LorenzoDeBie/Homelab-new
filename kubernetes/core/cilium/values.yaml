# Values passed to the cilium subchart
cilium:
  # Talos-specific settings
  ipam:
    mode: kubernetes

  # Disable kube-proxy replacement
  kubeProxyReplacement: true

  # Required for Talos
  securityContext:
    capabilities:
      ciliumAgent:
        - CHOWN
        - KILL
        - NET_ADMIN
        - NET_RAW
        - IPC_LOCK
        - SYS_ADMIN
        - SYS_RESOURCE
        - DAC_OVERRIDE
        - FOWNER
        - SETGID
        - SETUID
      cleanCiliumState:
        - NET_ADMIN
        - SYS_ADMIN
        - SYS_RESOURCE

  cgroup:
    autoMount:
      enabled: false
    hostRoot: /sys/fs/cgroup

  k8sServiceHost: localhost
  k8sServicePort: 7445

  # Gateway API
  gatewayAPI:
    enabled: true

  # L2 announcements for LoadBalancer services
  l2announcements:
    enabled: true

  externalIPs:
    enabled: true

  # Prometheus metrics for cilium-agent
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
      trustCRDsExist: true

  # Hubble for observability
  hubble:
    enabled: true
    relay:
      enabled: true
    ui:
      enabled: true
    metrics:
      enabled:
        - dns
        - drop
        - tcp
        - flow
        - icmp
        - httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction
      enableOpenMetrics: true
      serviceMonitor:
        enabled: true

  # Operator settings
  operator:
    replicas: 1
    prometheus:
      enabled: true
      serviceMonitor:
        enabled: true
        trustCRDsExist: true

  # Required for Tailscale Connector subnet routing
  # When Cilium replaces kube-proxy, socket LB bypass is needed
  # so Tailscale firewall rules (netfilter) work correctly
  socketLB:
    hostNamespaceOnly: true

  # BGP (optional, for advanced routing)
  bgpControlPlane:
    enabled: false
