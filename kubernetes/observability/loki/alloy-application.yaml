# Alloy - Log collector for Loki (Promtail replacement)
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: alloy
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: default
  source:
    repoURL: https://grafana.github.io/helm-charts
    chart: alloy
    targetRevision: "*"
    helm:
      valuesObject:
        controller:
          type: daemonset

        # Tolerate Talos control plane
        tolerations:
          - operator: Exists

        serviceMonitor:
          enabled: true

        alloy:
          mounts:
            varlog: true

          configMap:
            create: true
            content: |-
              logging {
                level  = "info"
                format = "logfmt"
              }

              discovery.kubernetes "pods" {
                role = "pod"
              }

              discovery.relabel "pods" {
                targets = discovery.kubernetes.pods.targets

                rule {
                  source_labels = ["__meta_kubernetes_namespace"]
                  target_label  = "namespace"
                }

                rule {
                  source_labels = ["__meta_kubernetes_pod_name"]
                  target_label  = "pod"
                }

                rule {
                  source_labels = ["__meta_kubernetes_pod_container_name"]
                  target_label  = "container"
                }

                rule {
                  source_labels = ["__meta_kubernetes_namespace", "__meta_kubernetes_pod_container_name"]
                  separator     = "/"
                  target_label  = "job"
                  replacement   = "$1/$2"
                }

                // Fallback app to container, then override from common pod labels when present.
                rule {
                  source_labels = ["__meta_kubernetes_pod_container_name"]
                  regex         = "(.+)"
                  target_label  = "app"
                  replacement   = "$1"
                }

                rule {
                  source_labels = ["__meta_kubernetes_pod_label_app"]
                  regex         = "(.+)"
                  target_label  = "app"
                  replacement   = "$1"
                }

                rule {
                  source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
                  regex         = "(.+)"
                  target_label  = "app"
                  replacement   = "$1"
                }

                rule {
                  source_labels = ["app"]
                  regex         = "(.+)"
                  target_label  = "service_name"
                  replacement   = "$1"
                }

                rule {
                  source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
                  separator     = "/"
                  target_label  = "__path__"
                  replacement   = "/var/log/pods/*$1/$2/*.log"
                }
              }

              local.file_match "pods" {
                path_targets = discovery.relabel.pods.output
              }

              loki.source.file "pods" {
                targets    = local.file_match.pods.targets
                forward_to = [loki.process.pods.receiver]
              }

              loki.process "pods" {
                stage.cri {}
                forward_to = [loki.write.default.receiver]
              }

              loki.write "default" {
                endpoint {
                  url = "http://loki.observability.svc.cluster.local:3100/loki/api/v1/push"
                }

                external_labels = {
                  cluster = "homelab",
                }
              }
  destination:
    server: https://kubernetes.default.svc
    namespace: observability
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
