# Values passed to the kube-prometheus-stack subchart
kube-prometheus-stack:
  # Disable components we don't need or that conflict with Talos
  kubeControllerManager:
    enabled: true
    endpoints:
      - 192.168.30.50
    service:
      enabled: true
      port: 10257
      targetPort: 10257
    serviceMonitor:
      enabled: true
      https: true
      insecureSkipVerify: true
  
  kubeScheduler:
    enabled: true
    endpoints:
      - 192.168.30.50
    service:
      enabled: true
      port: 10259
      targetPort: 10259
    serviceMonitor:
      enabled: true
      https: true
      insecureSkipVerify: true
  
  kubeEtcd:
    enabled: true
    endpoints:
      - 192.168.30.50
    service:
      enabled: true
      port: 2381
      targetPort: 2381
  
  kubeProxy:
    enabled: false  # Replaced by Cilium
  
  # Grafana configuration
  grafana:
    enabled: true
    adminPassword: ""  # Set via secret
    admin:
      existingSecret: grafana-admin
      userKey: admin-user
      passwordKey: admin-password
    
    # Disable init-chown-data container - chown fails on NFS with Mapall
    initChownData:
      enabled: false
    
    # Run as UID/GID 3001 (media user) to match NFS Mapall setting
    securityContext:
      runAsUser: 3001
      runAsGroup: 3001
      fsGroup: 3001
    
    persistence:
      enabled: true
      storageClassName: nfs-config
      size: 5Gi
    
    sidecar:
      dashboards:
        enabled: true
        searchNamespace: ALL
      datasources:
        enabled: true
        searchNamespace: ALL
    
    # Additional data sources
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki.observability.svc.cluster.local:3100
        access: proxy
        isDefault: false
  
  # Prometheus configuration
  prometheus:
    prometheusSpec:
      retention: 30d
      retentionSize: 50GB
      
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: nfs-config
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 50Gi
      
      # Scrape all ServiceMonitors
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      ruleSelectorNilUsesHelmValues: false
      
      # Resource limits
      resources:
        requests:
          cpu: 200m
          memory: 1Gi
        limits:
          memory: 4Gi
  
  # Alertmanager configuration
  alertmanager:
    enabled: true
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: nfs-config
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
